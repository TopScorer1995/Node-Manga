<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<!-- attach Modal -->
<div class="modal fade" id="attach_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalPreviewLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      
      <div class="modal-body">
       <ul class="nav nav-tabs nav-justified md-tabs primary-color" id="myTabMD" role="tablist">
  <li class="nav-item attach_tap_button" form-data="chapter_form">
    <a class="nav-link active" id="home-tab-md" data-toggle="tab" href="#home-md" role="tab" aria-controls="home-md" aria-selected="true">فصل جديد</a>
  </li>
  <li class="nav-item attach_tap_button" form-data="series_form">
    <a class="nav-link" id="profile-tab-md" data-toggle="tab" href="#profile-md" role="tab" aria-controls="profile-md" aria-selected="false">سلسلة جديدة</a>
  </li>
  <li class="nav-item attach_tap_button" form-data="team_form">
    <a class="nav-link" id="contact-tab-md" data-toggle="tab" href="#contact-md" role="tab" aria-controls="contact-md" aria-selected="false">فريق جديد</a>
  </li>
</ul>
<div class="tab-content card pt-5" id="myTabContentMD">
  <div class="tab-pane fade show active" id="home-md" role="tabpanel" aria-labelledby="home-tab-md">
    <form id="chapter_form">
  <input type="hidden" name="manga" id="manga_id">
  <!--Dropdown danger-->
<div class="dropdown d-block w-100">
  <!--Trigger-->
  <div class="transparent text-gray d-block border-bottom py-2 w-100 text-right" type="button" id="manga_button" data-toggle="dropdown">إختيار سلسلة</div>

  <!--Menu-->
  <div class="dropdown-menu dropdown-primary w-100">
    <!-- Search form -->
    <div class="md-form my-2">
      <input class="form-control manga_search text-right" type="text" placeholder="بحث" aria-label="Search" >
    </div>
    <div id="manga_continer">
      


    
    </div>
  </div>
</div>
<!--/Dropdown danger-->
   <div class="md-form">
  <input placeholder="رقم الفصل" type="text" name="chapter_number" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="رقم المجلد" type="text" name="folder_number" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="عنوان الفصل (إختياري)" type="text" name="chapter_label" class="form-control text-right rtl">
   </div>


   <input type="hidden" name="team" id="team_id">
  <!--Dropdown danger-->
<div class="dropdown d-block w-100 my-4">
  <!--Trigger-->
  <div class="transparent text-gray d-block border-bottom py-2 w-100 text-right" type="button" id="team_button" data-toggle="dropdown">إختيار فريق</div>

  <!--Menu-->
  <div class="dropdown-menu dropdown-primary w-100">
    <!-- Search form -->
    <%if(admin.length>0){%>
    <div class="md-form my-2">
      <input class="form-control team_search text-right" type="text" placeholder="بحث" aria-label="Search" >
    </div>

    <%}%>
    
    <div id="teams_continer">

       <%my_teams.forEach(function(my_team,index){%>

<a class="dropdown-item mdb-dropdownLink-2 one_team_options" uid="<%=my_team.id%>"><div class="chip m-0 w-100 h-100 rounded-0 transparent"><img src="<%=my_team.team_profile%>" alt="Contact Person"><span class="team_name"><%=my_team.team_name%></span></div></a>

  <%})%>
      


    
    </div>
  </div>
</div>
<!--/Dropdown danger-->
   <form class="md-form rtl text-right">
    <div class="file-field">
        <div class="btn btn-primary btn-sm float-left">
            <span>إختيار</span>
            <input type="file" name="chapter" id="chapter">
        </div>
        <div class="file-path-wrapper">
            <input class="file-path validate text-right" type="text" placeholder="إختيار فصل">
        </div>
    </div>
</form>
</form>
  </div>
  <div class="tab-pane fade" id="profile-md" role="tabpanel" aria-labelledby="profile-tab-md">
    <form id="series_form" enctype="multipart/form-data">
    <div class="md-form">
  <input placeholder="إسم السلسلة" type="text" name="series_name" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="إسم السلسلة بالعربي" type="text" name="series_arabic_name" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="أسماء أخرى للسلسلة" type="text" name="series_other_names" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="سنة الإصدار" type="text" name="product_year" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="مؤلف السلسلة" type="text" name="series_author" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="راسم السلسلة" type="text" name="series_painter" class="form-control text-right rtl">
   </div>
  
<select class="mdb-select md-form colorful-select dropdown-primary prevent-close" multiple searchable="بحث" name="classes">
  <option value=""  selected="selected">التصنيفات</option>
  <%for(var i=0;i<classes.length;i++){%>

    <option value="<%=classes[i]%>"><%=classes[i]%></option>

  <%}%>
</select>
<button type="button" class="btn-save btn btn-primary btn-sm">Save</button>
<div class="form-group shadow-textarea">
  <textarea class="form-control z-depth-1 text-right rtl" name="description" rows="3" placeholder="وصف موجز للسلسلة..."></textarea>
</div>

    <div class="file-field">
        <div class="btn btn-primary btn-sm float-left">
            <span>إختيار </span>
            <input type="file" name="profile" id="series_profile">
        </div>
        <div class="file-path-wrapper">
            <input class="file-path validate text-right" type="text" placeholder="إختيار صورة للسلسلة">
        </div>
    </div>

</form>
  </div>
  <div class="tab-pane fade" id="contact-md" role="tabpanel" aria-labelledby="contact-tab-md">
    <form id="team_form">
   <div class="md-form">
  <input placeholder="إسم الفريق" type="text" name="team_name" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="موقع الفريق (إختياري)" type="text" name="website" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="البريد الإلكتروني" type="text" name="email" class="form-control text-right rtl">
   </div>
   <div class="md-form">
  <input placeholder="رابط صفحة الفريق على فايسبوك (إختياري)" type="text" name="facebook" class="form-control text-right rtl">
   </div>

   <div class="md-form">
  <input placeholder="رابط صفحة الفريق على تويتر  (إختياري)" type="text" name="twitter" class="form-control text-right rtl">
   </div>
   <div class="form-group shadow-textarea">
  <textarea class="form-control z-depth-1 text-right rtl" name="description" rows="3" placeholder="وصف موجز للفريق..."></textarea>
   </div>
   <form class="md-form">
    <div class="file-field">
        <div class="btn btn-primary btn-sm float-left">
            <span>إختيار</span>
            <input type="file" name="profile" id="team_profile">
        </div>
        <div class="file-path-wrapper">
            <input class="file-path validate text-right rtl" type="text" placeholder="إختيار صورة للفريق (إخيتاري)">
        </div>
    </div>
</form>
</form>
  </div>
  <div class="progress md-progress my-2 hide">
    <div class="progress-bar progress-bar-striped progress-bar-animated attach_progress_bar" role="progressbar" style="width: 0%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
</div>
  <button type="button" class="btn btn-primary add_new_item_trigger">إضافة <i class="fas fa-plus-circle"></i></button>
</div>
      </div>
    </div>
  </div>
</div>
<!-- /attach Modal -->



<script type="text/javascript">
  $('.mdb-select').materialSelect();
 var form_to_be_trigger="chapter_form"; 
$(document).on("click",".attach_tap_button",function(){form_to_be_trigger=$(this).attr("form-data");})
$(document).on("click",".add_new_item_trigger",function(){
if(form_to_be_trigger=="series_form")
    
  {
    if($("#series_profile")[0].files.length>0){
 if($("#series_profile")[0].files[0].size/1024/1024 > 5){
       toastr.error("حجم الملف يجب أن لا يتجاوز 5 ميجا")
       
    }else{

      var ext = $("#series_profile")[0].value.match(/\.([^\.]+)$/)[1];
    switch(ext)
    {
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'gif':
            upload_data();
            break;
        default:
            toastr.error('صيغة الملف غير مقبولة')
            
    }


    };}else{toastr.error("يجب إختيار صورة للسلسلة")}
  }else if(form_to_be_trigger=="team_form")

  {
    if($("#team_profile")[0].files.length>0){
 if($("#team_profile")[0].files[0].size/1024/1024 > 5){
       toastr.error("حجم الملف يجب أن لا يتجاوز 5 ميجا")
       
    }else{

      var ext = $("#team_profile")[0].value.match(/\.([^\.]+)$/)[1];
    switch(ext)
    {
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'gif':
            upload_data();
            break;
        default:
            toastr.error('صيغة الملف غير مقبولة')
            
    }


    };}else {upload_data()}
    


  }else if(form_to_be_trigger=="chapter_form")

  {
        if($("#chapter")[0].files.length>0)
          {
            var ext = $("#chapter")[0].value.match(/\.([^\.]+)$/)[1];
    switch(ext)
    {
        case 'zip':
            checkzip()
            break;
        default:
            toastr.error('صيغة الملف غير مقبولة فقط zip')
            
    }

          }else{toastr.error("الرجاء إختيار فصل")}
  }  

  })



$(document).on("keyup",".manga_search",function(){search_val=$(this).val();delay(function(){$.post("/search_data",{word:search_val},manga_search_result_handle)},1000)})
$(document).on("click",".one_manga_options",function(){$(".one_manga_options").removeClass("active");$(this).addClass("active");$("#manga_id").val($(this).attr("uid"));$("#manga_button").html($(this).find(".manga_name").html())})

$(document).on("keyup",".team_search",function(){search_val=$(this).val();delay(function(){$.post("/search_data",{word:search_val},team_search_result_handle)},1000)})
$(document).on("click",".one_team_options",function(){$(".one_team_options").removeClass("active");$(this).addClass("active");$("#team_id").val($(this).attr("uid"));$("#team_button").html($(this).find(".team_name").html())})

function upload_data()
{
    var form = new FormData($("#"+form_to_be_trigger)[0]);
  $.ajax({
       xhr: function()
  {
    var xhr = new window.XMLHttpRequest();
    //Upload progress
    xhr.upload.addEventListener("progress", function(evt){
      if (evt.lengthComputable) {
        var percentComplete = (evt.loaded / evt.total)*100;
        //Do something with upload progress
        update_attach_progress_bar(percentComplete);
      }
    }, false);
    
    return xhr;
  },
        url: "/"+form_to_be_trigger,
        method: "POST",
        dataType: 'html',
        data: form,
        processData: false,
        contentType: false,
        success:function(data){if(data!="1"){toastr.error(data);}else{location.reload()}}

});

}



function manga_search_result_handle(data){$("#manga_continer").html("");data.manga.forEach(function(manga,index){$("#manga_continer").append('<a class="dropdown-item mdb-dropdownLink-2 one_manga_options" uid="'+manga.id+'"><div class="chip m-0 w-100 h-100 rounded-0 transparent"><img src="'+manga.series_profile+'" alt="Contact Person"><span class="manga_name">'+manga.series_name+'</span></div></a>');})}

function team_search_result_handle(data){$("#teams_continer").html("");data.teams.forEach(function(row,index){$("#teams_continer").append('<a class="dropdown-item mdb-dropdownLink-2 one_team_options" uid="'+row.id+'"><div class="chip m-0 w-100 h-100 rounded-0 transparent"><img src="'+row.team_profile+'" alt="Contact Person"><span class="team_name">'+row.team_name+'</span></div></a>');})}


function checkzip()
{
  JSZip.loadAsync($("#chapter")[0].files[0])
.then(function(zip)
{   
    var i=0;
   zip.forEach(function (relativePath, zipEntry) {  
                
    
    var ext = zipEntry.name.match(/\.([^\.]+)$/)[1];
    switch(ext)
    {
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'gif':
            if(i==Object.entries(zip.files).map(([k, v]) => ([Number(k), v])).length-1){upload_data();}
            break;
        default:
            toastr.error("محتوى الملف يجب أن تكون صور فقط");return;
            
    }
                
i++;

})
})
}
$('[data-toggle="popover"]').popover();
function update_attach_progress_bar(precent){$(".attach_progress_bar").css("width",precent+"%");if(precent<100){$(".attach_progress_bar").parent().removeClass("hide")}else{$(".attach_progress_bar").parent().addClass("hide")}}
</script>